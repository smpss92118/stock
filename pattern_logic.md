# 型態識別邏輯與回測分析

## 一、型態識別邏輯 (Pattern Recognition Logic)

本系統針對 VCP、HTF、CUP 三種型態進行識別，以下是實際實現的邏輯說明與績效分析。

### 1. Volatility Contraction Pattern (VCP)

**識別邏輯：**

*   **趨勢條件**：視窗內最高價相對於起始價上漲幅度 ≥ 40% (`min_up_ratio=0.4`)
*   **ZigZag 動態腿部識別**：
    *   使用 ZigZag 算法 (5% 敏感度) 識別擺動高點 (Swing Highs) 和擺動低點 (Swing Lows)
    *   從視窗最高點開始分析整理區域
    *   至少需要 2 個波谷 (Troughs) 才能形成有效的收縮型態
*   **收斂驗證**：
    *   **波幅遞減**：每一段的回檔深度 (Amplitude) 必須逐段遞減
        - 深度計算：`Depth_i = (Peak_i - Trough_i) / Peak_i`
        - 條件：`Depth_{i+1} < Depth_i`
    *   **低點墊高**：每一段的最低點需逐段墊高 (允許 2% 容差)
        - 條件：`Trough_{i+1} >= Trough_i * 0.98`
*   **成交量過濾 (Dry Up)**：
    *   計算最後 3 天的平均成交量
    *   要求：`Avg_Vol_Last3Days < Vol_MA50 * 0.6` (60% 門檻)
    *   此條件確保突破前成交量極度萎縮
*   **買點**：最後一個波峰 (Peak) 的價格
*   **停損**：最後一個波谷 (Trough) 的價格

**績效分析 (有限資金，100萬初始資金)：**

| 策略 | 報酬率 | 夏普比率 | 勝率 | 交易次數 | 最大回撤 |
|------|--------|----------|------|----------|----------|
| VCP (R=2.0, T=20) | -6.8% | -0.16 | 35.9% | 795 | -27.5% |
| VCP (R=3.0, T=20) | -10.6% | -0.21 | 32.5% | 452 | -36.1% |
| VCP (Trig=1.5R, Trail=MA20) | 23.0% | 0.31 | 27.1% | 387 | -31.3% |

**結論與建議：**

*   **表現不佳**：VCP 在有限資金場景下表現最差，固定出場策略呈現負報酬
*   **可能原因**：
    1. ZigZag 敏感度 (5%) 可能過於寬鬆，導致誤判
    2. 最低上漲幅度 (40%) 可能不足以過濾弱勢型態
    3. 成交量過濾條件可能過於嚴格，錯失有效訊號
*   **改進方向**：
    1. 調整 ZigZag 敏感度至 3-4%
    2. 提高最低上漲幅度至 50-60%
    3. 加入相對強度 (RS) 過濾，確保股票處於領先地位

---

### 2. High Tight Flag (HTF)

**識別邏輯：**

*   **旗桿 (Pole)**：視窗內最高價相對於起始價上漲 ≥ 80% (`min_up_ratio=0.8`)
*   **旗形 (Flag)**：
    *   整理天數在 3 ~ 12 天之間 (`min_flag_days=3`, `max_flag_days=12`)
    *   整理區回檔幅度不超過 25% (`max_pullback=0.25`)
    *   整理區平均成交量 < 上漲區平均成交量
*   **買點**：整理區 (Flag) 的最高價
*   **停損**：整理區 (Flag) 的最低價

**績效分析 (有限資金，100萬初始資金)：**

| 策略 | 報酬率 | 夏普比率 | 勝率 | 交易次數 | 最大回撤 |
|------|--------|----------|------|----------|----------|
| HTF (R=2.0, T=20) | **155.1%** | **1.52** | 48.3% | 543 | -15.1% |
| HTF (Trig=1.5R, Trail=MA20) | **288.3%** | 1.11 | 36.7% | 275 | -14.7% |
| HTF (R=3.0, T=20) | 131.8% | 1.19 | 44.4% | 473 | -17.0% |
| HTF (R=2.0, T=60) | 50.5% | 0.57 | 43.0% | 363 | -30.3% |

**結論與建議：**

*   **優異表現**：HTF 展現最高的絕對報酬率 (155-288%)
*   **風險調整後績效**：夏普比率 1.11-1.52，顯示良好的風險調整報酬
*   **特點**：
    1. 80% 漲幅門檻有效過濾弱勢型態，確保動能強勁
    2. 短期整理 (3-12 天) 捕捉快速突破機會
    3. 成交量萎縮確認整理有效性
    4. **追蹤止損策略表現優異**：Trig=1.5R, Trail=MA20 達到 288.3% 報酬
*   **改進方向**：
    1. 可考慮放寬天數限制至 15-20 天，捕捉更多強勢整理
    2. 加入移動平均線支撐確認 (如 MA10 或 MA20)

---

### 3. Cup with Handle (CUP)

**識別邏輯：**

*   **趨勢模板 (Trend Template - Minervini)**：
    *   **MA 排列**：`Price > MA50 > MA150 > MA200`
    *   **MA200 趨勢**：MA200 呈上升趨勢 (斜率 > 0)
    *   **52 週低點**：當前價格至少高於 52 週低點 25%
        - 條件：`Current_Price > Low_52Week * 1.25`
*   **杯身 (Cup)**：
    *   左側高點位於視窗前半段
    *   底部回檔深度在 12% ~ 33% 之間 (`min_depth=0.12`, `max_depth=0.33`)
    *   底部位置需大約在視窗中間 (U 型而非 V 型)
*   **把手 (Handle)**：
    *   位於右側高點之後
    *   長度至少為視窗的 20% 或 5 天
    *   **位置限制**：把手最低點必須在杯身深度的上半部
        - 條件：`Handle_Low > Cup_Low + 0.5 * (Cup_High - Cup_Low)`
    *   **漂移過濾**：把手區域必須呈現「價跌量縮」
        - 條件：`Handle_Vol_Mean < Window_Vol_Mean`
*   **買點**：把手區的最高價
*   **停損**：把手區的最低價

**績效分析 (有限資金，100萬初始資金)：**

| 策略 | 報酬率 | 夏普比率 | 勝率 | 交易次數 | 最大回撤 |
|------|--------|----------|------|----------|----------|
| CUP (R=3.0, T=20) | **152.5%** | **2.31** | 56.7% | 284 | -7.2% |
| CUP (R=2.0, T=20) | **133.1%** | **2.54** | 59.7% | 295 | **-6.5%** |
| CUP (R=2.0, T=60) | 75.7% | 1.55 | 55.8% | 163 | -11.3% |
| CUP (R=3.0, T=60) | 77.5% | 1.39 | 50.4% | 125 | -13.3% |
| CUP (Trig=1.5R, Trail=MA50) | 46.3% | 0.75 | 40.6% | 106 | -10.0% |

**結論與建議：**

*   **最佳風險調整報酬**：CUP 展現最高的夏普比率 (2.31-2.54)
*   **穩定勝率**：勝率維持在 50-60%，顯示型態可靠性高
*   **極低回撤**：最大回撤僅 6.5-7.2%，風險控制優異
*   **特點**：
    1. 趨勢模板有效過濾弱勢股票，確保處於上升趨勢
    2. 把手位置限制避免深度回檔的失敗型態
    3. 成交量漂移過濾確認整理健康
    4. **固定目標策略優於追蹤止損**：20天時間出場表現最佳
*   **最佳參數**：R=2.0-3.0, 時間出場=20天
*   **改進方向**：
    1. 可考慮加入相對強度 (RS) 排名，優先選擇領先股
    2. 細化把手長度要求，避免過短或過長的把手

---

## 二、回測框架 (Backtest Framework)

### 回測參數

1.  **策略 (Strategy)**: VCP, HTF, CUP
2.  **出場策略**：
    *   **固定目標 (Fixed Target)**: 2R, 3R
    *   **時間出場 (Time Exit)**: 20 天, 60 天
    *   **追蹤止損 (Trailing Stop)**: 
        - **觸發條件**：達到 1.5R 或 2R 獲利
        - **初始動作**：止損立即移至損益兩平 (Breakeven = 買入價)
        - **MA 追蹤**：跟隨 MA20 或 MA50，止損永不下移
        - **出場條件**：當日最低價 ≤ 當前止損
3.  **資金管理 (Capital Management)**：
    *   **Scenario 1 (有限資金)**: 
        - 初始資金：100 萬
        - 單筆上限：10% (10 萬)
        - 最多持倉：10 檔
        - 分配原則：先進先出 (FIFO)
    *   **Scenario 2 (無限資金)**: 
        - 所有符合訊號皆進場
        - 用於理論績效比較

### 統計指標

*   **勝率 (Win Rate)**: 獲利交易佔總交易的比例
*   **總獲利 (Total Profit)**: 所有交易的累積損益
*   **報酬率 (Return %)**: `(Final_Equity - Initial_Capital) / Initial_Capital * 100`
*   **最大回撤 (Max Drawdown)**: 淨值曲線的最大跌幅百分比
*   **夏普比率 (Sharpe Ratio)**: 年化風險調整報酬
    - 計算公式：`(Avg_Daily_Return - Risk_Free_Rate) / Std_Daily_Return * sqrt(252)`
*   **最大連續獲利/虧損 (Max Consecutive Win/Loss)**: 連續獲利/虧損交易的最大次數
*   **交易次數 (Count)**: 總交易筆數

### 進場邏輯

1.  **訊號生成**：每日檢查是否符合型態條件
2.  **進場觸發**：訊號生成後 30 天內，當日最高價 ≥ 買入價即觸發進場
3.  **資金檢查** (有限資金場景)：
    *   檢查當前現金是否足夠 (≥ 單筆上限)
    *   檢查持倉數量是否未達上限 (< 10 檔)
4.  **部位規模**：固定使用總資產的 10%

### 出場邏輯

#### 固定目標策略

1.  **止損出場**：當日最低價 ≤ 停損價
2.  **目標出場**：當日最高價 ≥ 目標價 (買入價 + R * 風險)
3.  **時間出場**：持有天數達到設定值，以收盤價出場
4.  **優先順序**：止損 > 目標 > 時間

#### 追蹤止損策略

1.  **初始止損**：使用型態識別的停損價
2.  **觸發條件**：當日最高價 ≥ 觸發價 (買入價 + Trigger_R * 風險)
3.  **止損上移至損益兩平**：觸發後立即將止損移至買入價
4.  **MA 動態追蹤**：每日更新止損為 `max(當前止損, MA值)`
5.  **出場條件**：當日最低價 ≤ 當前止損

### 績效總結

#### 有限資金場景 (Top 10)

| 排名 | 策略 | 設定 | 報酬率 | 夏普比率 | 勝率 | 交易次數 | 最大回撤 |
|------|------|------|--------|----------|------|----------|----------|
| 1 | HTF | Trig=1.5R, Trail=MA20 | **288.3%** | 1.11 | 36.7% | 275 | -14.7% |
| 2 | HTF | R=2.0, T=20 | **155.1%** | **1.52** | 48.3% | 543 | -15.1% |
| 3 | CUP | R=3.0, T=20 | **152.5%** | **2.31** | 56.7% | 284 | -7.2% |
| 4 | HTF | Trig=2.0R, Trail=MA20 | 138.7% | 0.70 | 28.8% | 236 | -18.2% |
| 5 | CUP | R=2.0, T=20 | 133.1% | **2.54** | 59.7% | 295 | **-6.5%** |
| 6 | HTF | R=3.0, T=20 | 131.8% | 1.19 | 44.4% | 473 | -17.0% |
| 7 | HTF | Trig=2.0R, Trail=MA50 | 124.3% | 0.60 | 24.8% | 214 | -17.1% |
| 8 | HTF | Trig=1.5R, Trail=MA50 | 101.0% | 0.55 | 24.1% | 253 | -28.5% |
| 9 | CUP | R=3.0, T=60 | 77.5% | 1.39 | 50.4% | 125 | -13.3% |
| 10 | CUP | R=2.0, T=60 | 75.7% | 1.55 | 55.8% | 163 | -11.3% |

#### 關鍵發現

1.  **HTF 追蹤止損表現優異**：
    - HTF + 追蹤止損 (Trig=1.5R, Trail=MA20) 達到 **288.3% 報酬**
    - 適合動能強勁的股票，讓獲利部位持續奔跑
    - MA20 追蹤比 MA50 更靈敏，適合快速移動的股票
    
2.  **CUP 最穩健**：
    - 最高夏普比率 (2.31-2.54)，最低回撤 (-6.5% to -7.2%)
    - 固定目標策略 (R=2.0-3.0, T=20) 表現最佳
    - 勝率高達 56-60%，顯示型態可靠性極高
    
3.  **HTF 最激進**：
    - 固定目標策略 (R=2.0, T=20) 有 155.1% 報酬，夏普 1.52
    - 追蹤止損策略可達 288.3% 報酬
    - 適合追求高報酬的積極型投資者
    
4.  **VCP 需改進**：
    - 表現不佳，多數策略呈現負報酬或低報酬
    - 需要重新調整參數或過濾條件
    
5.  **最佳時間出場**：
    - **20 天**為最佳平衡點（CUP 和 HTF 皆表現優異）
    - 60 天時間出場報酬率較低，可能錯過最佳出場時機

---

## 三、實現細節

### 技術架構

*   **數據處理**：Polars (高效能 DataFrame)
*   **向量化運算**：NumPy (快速數值計算)
*   **並行處理**：ProcessPoolExecutor (多核心加速)
*   **視窗大小**：126 天 (約 6 個月)

### 程式檔案

*   **[pattern_analysis.py](file:///Users/sony/ml_stock/stock/pattern_analysis.py)**: 型態識別與訊號生成
*   **[backtest_patterns.py](file:///Users/sony/ml_stock/stock/backtest_patterns.py)**: 回測引擎與績效計算

---

## 四、未來改進方向

### VCP 型態優化

1.  調整 ZigZag 敏感度 (3-4%)
2.  提高最低上漲幅度門檻 (50-60%)
3.  加入相對強度 (RS) 過濾
4.  細化成交量過濾條件

### 資金管理優化

1.  **Kelly Criterion**: 根據勝率和賠率動態調整部位大小
2.  **波動率調整**: 根據 ATR 或歷史波動率調整部位
3.  **風險平價**: 確保每筆交易的風險相等

### 交易成本建模

1.  加入手續費 (0.1425% * 折扣)
2.  加入證交稅 (0.3%)
3.  加入滑價模型 (Slippage)

### 穩健性測試

1.  **Walk-Forward Analysis**: 滾動式樣本內外測試
2.  **Monte Carlo Simulation**: 隨機排列測試
3.  **參數敏感度分析**: 測試參數變化對績效的影響
