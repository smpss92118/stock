# 開發指南

本文件提供實驗、優化與開發新功能的指導方針。

## 開發環境設定

### 環境需求

- **Python**: 3.11+
- **依賴管理**: Poetry
- **主要套件**: Pandas, NumPy, Polars, XGBoost, CatBoost, yfinance

### 初始化環境

```bash
cd /Users/sony/ml_stock/stock

# 安裝依賴
poetry install

# 啟動虛擬環境
poetry shell

# 驗證安裝
python -c "import xgboost, catboost; print('OK')"
```

---

## 新增策略型態

### 步驟 1: 定義型態邏輯

在 `src/strategies/` 建立新檔案 (如 `new_pattern.py`):

**範本結構**:
```python
def detect_new_pattern(window, param1, param2, rs_rating=0.0):
    """
    偵測新型態
    
    Args:
        window: pandas DataFrame, 126 天價量數據
        param1: 參數 1
        param2: 參數 2
        rs_rating: RS Rating
        
    Returns:
        (is_pattern, buy_price, stop_price, extra_info)
    """
    # 實作偵測邏輯
    # 1. 基礎過濾 (數據長度、RS Rating)
    # 2. 型態條件判斷
    # 3. 計算買入價與停損價
    # 4. 返回結果
    
    return True, float(buy_price), float(stop_price), extra_info
```

### 步驟 2: 整合至掃描流程

修改 `scripts/run_daily_scan.py`:
```python
from src.strategies.new_pattern import detect_new_pattern

# 在掃描循環中加入
is_new, buy, stop, info = detect_new_pattern(window, param1=X, param2=Y, rs_rating=rs_rating)
if is_new:
    # 記錄訊號
```

### 步驟 3: 測試驗證

**手動測試**:
```bash
# 執行單次掃描
poetry run python scripts/run_daily_scan.py

# 檢查輸出
cat data/processed/latest_signals.csv | grep NEW_PATTERN
```

**回測驗證**:
```bash
# 執行歷史分析
poetry run python scripts/run_historical_analysis.py

# 執行回測
poetry run python scripts/run_backtest.py

# 查看績效
cat data/processed/backtest_results_v2.csv
```

---

## 調整 ML 模型

### 場景 1: 調整特徵

**修改位置**: `src/ml/features.py`

**新增特徵**:
1. 在 `extract_ml_features` 函數中加入新特徵計算邏輯
2. 更新 `feature_cols` 列表
3. 重新訓練模型

**範例**:
```python
def extract_ml_features(row, pattern_type):
    features = {}
    # ... existing features ...
    
    # 新增特徵
    features['new_feature'] = calculate_new_feature(row)
    
    return features
```

### 場景 2: 調整模型參數

**修改位置**: `ml_enhanced/scripts/train_models.py`

**調整 XGBoost 參數**:
```python
params = {
    'max_depth': 5,         # 增加深度 (原 3)
    'learning_rate': 0.05,  # 降低學習率 (原 0.1)
    'n_estimators': 300,    # 增加樹數量 (原 100)
    # ... other params ...
}
```

**重新訓練**:
```bash
poetry run python ml_enhanced/weekly_retrain.py
```

### 場景 3: 調整 ML 閾值

**目的**: 測試不同 ML 分數閾值對績效的影響

**方法**: 修改回測腳本中的 threshold 參數
```python
# ml_enhanced/scripts/run_ml_backtest.py
for threshold in [0.3, 0.4, 0.5, 0.6]:
    # 過濾訊號
    signals_filtered = signals[signals['ml_proba'] >= threshold]
    # 回測
```

---

## 超參數優化

### 使用 optimization/

**目的**: 系統化尋找最佳策略參數

**現有優化腳本**: `optimization/optimize_hyperparameters.py`

### 優化流程

**1. 定義參數空間**:
```python
param_grid = {
    'min_up_ratio': [0.6, 0.8, 1.0],
    'max_pullback': [0.15, 0.20, 0.25],
    'min_flag_days': [3, 5, 7],
    'max_flag_days': [10, 12, 15]
}
```

**2. 網格搜索**:
```python
for params in product(*param_grid.values()):
    # 使用參數組合執行回測
    result = run_backtest_with_params(params)
    # 記錄績效
```

**3. 評估結果**:
- 按年化報酬、Sharpe、勝率排序
- 選擇最佳參數組合
- 避免過度優化 (Out-of-sample 驗證)

**4. 應用最佳參數**:
- 更新策略程式碼中的預設參數
- 記錄優化過程與結果 (docs/optimization/)

### 注意事項

**避免過度擬合**:
- 使用 Walk-Forward 驗證
- 保留部分數據作為驗證集
- 優化參數應合理 (不應過於極端)

---

## 實驗流程

### 使用 experiments/

**目的**: 測試新想法，不影響生產系統

### 實驗範本

**1. 建立實驗目錄**:
```bash
mkdir experiments/new_idea_YYYYMMDD
cd experiments/new_idea_YYYYMMDD
```

**2. 撰寫實驗腳本**:
```python
# test_new_idea.py
import sys
sys.path.append('../..')

from src.strategies.htf import detect_htf
from scripts.run_backtest import run_backtest

# 實驗邏輯
# ...

# 輸出結果
print(f"Experiment Result: {result}")
```

**3. 執行實驗**:
```bash
poetry run python test_new_idea.py > results.log
```

**4. 記錄結果**:
- 建立 `experiments/new_idea_YYYYMMDD/README.md`
- 記錄實驗目的、方法、結果、結論
- 如果成功，整合到主系統；否則歸檔

---

## 測試與驗證

### 單元測試

**位置**: 暫無 (可建立 `tests/` 目錄)

**建議**:
- 測試型態偵測函數的邊界條件
- 測試特徵提取的正確性
- 測試回測引擎的資金管理邏輯

### 整合測試

**手動端到端測試**:
```bash
# 完整流程測試
poetry run python main.py
poetry run python ml_enhanced/daily_ml_scanner.py
poetry run python catboost_enhanced/daily_ml_scanner.py

# 檢查報告生成
ls -la daily_tracking_stock/YYYY-MM-DD/
ls -la ml_enhanced/daily_reports/YYYY-MM-DD/
ls -la catboost_enhanced/results/
```

### 績效驗證

**對比基準**:
- Buy & Hold 市場指數
- 隨機訊號 (Random Entry)
- 原始策略 vs ML Enhanced vs CatBoost Enhanced

**關鍵指標**:
- 年化報酬 > 市場指數
- Sharpe > 1.5
- Max DD < 30%
- 勝率 > 60%

---

## 開發最佳實踐

### 程式碼風格

**遵循現有慣例**:
- 使用 snake_case 命名
- 函數加入 docstring 說明
- 複雜邏輯加入註解 (說明「為何」而非「什麼」)

### 版本控制

**Git 工作流程**:
```bash
# 每完成一個邏輯單元就 commit
git add changed_files
git commit -m "feat: add new pattern detection logic"

# 重要: 不要 push (僅本地開發)
```

**Commit 訊息格式** (Conventional Commits):
- `feat:` 新功能
- `fix:` 修復 bug
- `docs:` 文件更新
- `refactor:` 重構
- `chore:` 維護性工作

### 文件更新

**同步更新文件**:
- 新增功能時更新相關 .md 文件
- 修改核心邏輯時更新系統文件
- README.md 保持最新的系統狀態

---

## 故障排除

### 常見問題

**1. 依賴安裝失敗**

**解決**:
```bash
# 清除 cache
poetry cache clear pypi --all

# 重新安裝
poetry install
```

**2. 數據下載錯誤**

**症狀**: yfinance 返回空數據或錯誤

**解決**:
- 檢查網路連線
- 確認股票代號格式 (XXXX.TW)
- 降低請求頻率 (加入延遲)

**3. ML 模型訓練記憶體不足**

**解決**:
- 減少訓練數據量 (縮短歷史範圍)
- 調整 XGBoost `n_jobs` 參數
- 分批訓練 (針對單一 pattern 訓練)

**4. 回測結果異常**

**檢查**:
- 數據完整性 (是否有缺失)
- 進出場邏輯 (是否有 bug)
- 資金管理計算 (現金是否正確更新)

---

## 相關文件

- [系統架構](file:///Users/sony/ml_stock/stock/docs/01_系統架構.md) - 理解整體設計
- [型態策略](file:///Users/sony/ml_stock/stock/docs/03_型態策略.md) - 型態偵測邏輯
- [ML Enhanced 系統](file:///Users/sony/ml_stock/stock/docs/05_ML_Enhanced系統.md) - ML 模型開發
- [回測引擎](file:///Users/sony/ml_stock/stock/docs/07_回測引擎.md) - 回測邏輯理解

## 實作參考

- 策略範例: [src/strategies/htf.py](file:///Users/sony/ml_stock/stock/src/strategies/htf.py)
- 優化範例: [optimization/optimize_hyperparameters.py](file:///Users/sony/ml_stock/stock/optimization/optimize_hyperparameters.py)
- ML 特徵: [src/ml/features.py](file:///Users/sony/ml_stock/stock/src/ml/features.py)
- 回測引擎: [scripts/backtest_engine_v2.py](file:///Users/sony/ml_stock/stock/scripts/backtest_engine_v2.py)
