# 型態識別邏輯與回測分析

## 一、型態識別邏輯 (Pattern Recognition Logic)

本系統針對 VCP、HTF、CUP 三種型態進行識別，以下是實際實現的邏輯說明與績效分析。

---

## 🏆 Cup with Handle (CUP) - 最佳策略

### 型態概述

Cup with Handle（杯柄型態）是由 William O'Neil 提出的經典突破型態，代表股票經過健康的整理後準備突破。此型態在台股市場表現最佳，具有**最高勝率（56.9%）**和**最佳風險調整報酬（Sharpe 2.24）**。

### 詳細識別條件

#### 1. 趨勢模板過濾 (Trend Template - Minervini)

**目的**: 確保股票處於強勢上升趨勢中

```python
# 必要條件（全部滿足）
✓ 當前價格 > MA50 > MA150 > MA200  # 移動平均線正向排列
✓ 當前價格 > 52週低點 × 1.25       # 至少高於年低點 25%
✓ MA200 呈上升趨勢                 # 長期趨勢向上
```

**實務意義**:
- MA 正向排列代表多頭趨勢確立
- 遠離 52 週低點代表股票已走出底部
- MA200 上升確保大趨勢向上

#### 2. 杯身 (Cup) 識別

**形狀要求**: U 型底部（非 V 型）

```python
# 杯身參數
視窗大小: 126 天（約 6 個月）
左側高點: 位於視窗前半段（前 50%）
底部位置: 約在視窗中間（50-75% 區間）
回檔深度: 12% ~ 33%

# 深度計算
Cup_Depth = 1 - (底部價格 / 左側高點價格)
```

**品質標準**:
- ✅ **最佳深度**: 15-25%（太淺不健康，太深風險高）
- ✅ **U 型底部**: 底部應緩慢形成，非急跌急漲
- ✅ **時間充足**: 整個杯身應至少 4-8 週

#### 3. 把手 (Handle) 識別

**目的**: 確認最後一次健康的洗盤

```python
# 把手參數
長度: 視窗的 20% 或至少 5 天
位置要求: 把手最低點 > 杯底 + 0.5 × 杯身深度
深度限制: 把手深度 < 15%（相對於把手起點）

# 位置計算
Cup_Range = 右側高點 - 杯底價格
Min_Handle_Low = 杯底價格 + 0.5 × Cup_Range
```

**品質標準**:
- ✅ **位置**: 把手應在杯身的**上半部**形成（理想在上 1/3）
- ✅ **深度**: 把手回檔不應超過 15%
- ✅ **時間**: 1-4 週為佳（太短不穩定，太長失去動能）
- ✅ **成交量**: 把手區成交量 < 整體平均成交量（價跌量縮）

#### 4. 相對強度過濾 (RS Filter)

```python
# RS 計算
RS_Rating = 股票 52 週報酬率 - 市場 52 週報酬率

# 過濾條件
✓ RS_Rating > 0  # 股票必須跑贏大盤
```

**實務意義**:
- 只選擇相對強勢的股票
- 避開弱勢股的假突破

### 進場點位設計

#### 買入價 (Buy Price)

```python
Buy_Price = 把手區的最高價
```

**進場邏輯**:
1. 訊號生成後，監控 30 天
2. 當日最高價 ≥ Buy_Price 時觸發進場
3. 以 Buy_Price 成交（保守估計）

**實務建議**:
- 可在突破當日收盤前確認成交量放大（至少 1.5 倍平均量）
- 理想情況下，突破日應為長紅 K 線
- 可設定限價單在 Buy_Price 附近等待

#### 停損價 (Stop Price)

```python
Stop_Price = 把手區的最低價
```

**風險計算**:
```python
Risk = Buy_Price - Stop_Price
Risk_Percentage = Risk / Buy_Price × 100%
```

**典型風險**: 5-10%（把手深度決定）

### 最佳停損停利方式

#### 🥇 方案一：固定目標 + 時間出場（推薦）

**參數設定**:
```python
目標獲利: 3R (即 3 倍風險)
時間出場: 20 天
初始停損: Stop_Price
```

**出場邏輯**:
```python
# 優先順序
1. 止損出場: 當日最低價 ≤ Stop_Price → 立即出場
2. 目標出場: 當日最高價 ≥ Buy_Price + 3R → 獲利了結
3. 時間出場: 持有 20 天 → 以收盤價出場
```

**績效表現** (含複利):
- **報酬率**: 314.3%
- **勝率**: 56.9%
- **Sharpe**: 2.24
- **最大回撤**: -12.2%
- **交易次數**: 276

**適用情境**:
- ✅ 穩健型投資者
- ✅ 追求高勝率和低回撤
- ✅ 不想頻繁盯盤

#### 🥈 方案二：固定目標 2R + 時間出場

**參數設定**:
```python
目標獲利: 2R
時間出場: 20 天
```

**績效表現** (含複利):
- **報酬率**: 193.1%
- **勝率**: 57.3%
- **Sharpe**: 2.16
- **最大回撤**: -14.5%

**適用情境**:
- ✅ 更保守的獲利目標
- ✅ 提高勝率優先
- ✅ 快速資金周轉

#### 方案三：追蹤止損（不推薦 CUP）

**參數設定**:
```python
觸發條件: 1.5R 獲利
追蹤 MA: MA50
```

**績效表現**: 54.2% 報酬（遠低於固定目標）

**不推薦原因**:
- CUP 突破後通常有明確的目標位（1.5 倍杯深）
- 追蹤止損容易過早出場，錯失主升段
- 固定目標策略更符合 CUP 的價格行為

### 倉位管理建議

```python
# 基礎倉位
單筆倉位 = 總資產 × 10%

# 風險控制
每筆交易風險 = 倉位 × (Buy_Price - Stop_Price) / Buy_Price
建議每筆風險 ≤ 總資產 × 1%

# 範例
總資產 = 100 萬
單筆倉位 = 10 萬
Buy_Price = 100 元
Stop_Price = 93 元
風險 = 10 萬 × 7% = 7,000 元（0.7% 總資產）✓
```

### 實戰檢查清單

**進場前確認**:
- [ ] MA 排列正確（Price > MA50 > MA150 > MA200）
- [ ] 價格 > 52 週低點 × 1.25
- [ ] 杯身深度在 12-33% 之間
- [ ] 把手在杯身上半部
- [ ] 把手成交量萎縮
- [ ] RS Rating > 0（跑贏大盤）
- [ ] 突破日成交量放大

**進場後管理**:
- [ ] 設定停損單在 Stop_Price
- [ ] 設定目標價在 Buy_Price + 3R
- [ ] 記錄進場日期（20 天後檢查）
- [ ] 不要因為短期波動而改變計畫

---

## 🚀 High Tight Flag (HTF) - 高報酬策略

### 型態概述

High Tight Flag（高緊旗型）是一種罕見但威力強大的突破型態，代表股票在短期內大幅上漲後進行短暫整理，隨後繼續上攻。此型態在台股市場表現優異，具有**最高絕對報酬（210.1%）**。

### 詳細識別條件

#### 1. 旗桿 (Pole) 識別

**目的**: 確認前期有強勁的上漲動能

```python
# 旗桿參數
視窗大小: 126 天
最低漲幅: 60%（已從 80% 放寬至 60%）

# 漲幅計算
Pole_Gain = (視窗最高價 / 視窗起始價) - 1
要求: Pole_Gain ≥ 0.60 (60%)
```

**品質標準**:
- ✅ **最佳漲幅**: 80-120%（漲幅越大，後續動能越強）
- ✅ **上漲速度**: 最好在 4-8 週內完成（快速上漲代表強勁動能）
- ✅ **成交量**: 上漲過程中成交量應逐步放大

#### 2. 旗形 (Flag) 識別

**目的**: 確認健康的短期整理

```python
# 旗形參數
整理天數: 3 ~ 12 天
最大回檔: 25%（相對於旗桿最高點）
成交量要求: 旗形平均量 < 旗桿平均量

# 回檔計算
Pullback = 1 - (旗形最低價 / 旗桿最高價)
要求: Pullback ≤ 0.25 (25%)
```

**品質標準**:
- ✅ **最佳回檔**: 10-20%（太淺不穩定，太深失去動能）
- ✅ **最佳天數**: 5-10 天（太短不穩定，太長失去動能）
- ✅ **成交量**: 整理期間成交量應明顯萎縮（至少減少 30%）
- ✅ **形狀**: 應呈現橫向或略向下的旗形，非 V 型反轉

#### 3. 相對強度過濾 (RS Filter)

```python
# RS 計算
RS_Rating = 股票 52 週報酬率 - 市場 52 週報酬率

# 過濾條件
✓ RS_Rating > 0  # 股票必須跑贏大盤
```

**實務意義**:
- HTF 本身已代表強勢（60% 漲幅）
- RS > 0 進一步確認相對強度
- 實測發現此過濾器對 HTF 影響不大（因為 HTF 本身就很強）

#### 4. HTF 品質評級系統 (Grading System)

**目的**: 區分 HTF 的品質等級

```python
# A 級 HTF（最高品質）
✓ 旗桿漲幅 > 90%
✓ 旗形回檔 < 15%
✓ 成交量萎縮 > 50%

# B 級 HTF（良好品質）
✓ 旗桿漲幅 > 90%
✓ 旗形回檔 15-20%

# C 級 HTF（一般品質）
✓ 旗形回檔 20-25%
```

**未來應用**:
- A 級可使用 15% 倉位
- B 級可使用 10% 倉位
- C 級可使用 5% 倉位
- 目前尚未實施動態倉位調整

### 進場點位設計

#### 買入價 (Buy Price)

```python
Buy_Price = 旗形區的最高價
```

**進場邏輯**:
1. 訊號生成後，監控 30 天
2. 當日最高價 ≥ Buy_Price 時觸發進場
3. 以 Buy_Price 成交（保守估計）

**實務建議**:
- HTF 突破通常非常快速，需要及時反應
- 可使用市價單或限價單在 Buy_Price + 0.5% 範圍內
- 突破日成交量應明顯放大（至少 1.5-2 倍平均量）
- 理想情況下，突破應伴隨跳空缺口

#### 停損價 (Stop Price)

```python
Stop_Price = 旗形區的最低價
```

**風險計算**:
```python
Risk = Buy_Price - Stop_Price
Risk_Percentage = Risk / Buy_Price × 100%
```

**典型風險**: 10-25%（旗形回檔深度決定）

### 最佳停損停利方式

#### 🥇 方案一：追蹤止損（推薦 - 最高報酬）

**參數設定**:
```python
觸發條件: 1.5R 獲利
追蹤 MA: MA20
初始停損: Stop_Price
```

**出場邏輯**:
```python
# 階段一：未觸發追蹤（獲利 < 1.5R）
當前停損 = Stop_Price
出場條件: 當日最低價 ≤ Stop_Price

# 階段二：觸發追蹤（獲利 ≥ 1.5R）
1. 立即將停損移至損益兩平: 當前停損 = Buy_Price
2. 每日更新停損: 當前停損 = max(當前停損, MA20)
3. 出場條件: 當日最低價 ≤ 當前停損
```

**績效表現** (含複利):
- **報酬率**: 210.1% 🏆
- **勝率**: 31.7%
- **Sharpe**: 0.79
- **最大回撤**: -39.7%
- **交易次數**: 338

**適用情境**:
- ✅ 積極型投資者
- ✅ 追求最高報酬
- ✅ 能承受較大回撤
- ✅ 願意讓獲利部位持續奔跑

**優勢**:
- 能捕捉 HTF 突破後的主升段
- MA20 追蹤靈敏，適合快速移動的股票
- 1.5R 觸發點確保有一定獲利才開始追蹤

#### 🥈 方案二：固定目標 2R + 時間出場

**參數設定**:
```python
目標獲利: 2R
時間出場: 20 天
```

**績效表現** (含複利):
- **報酬率**: 189.8%
- **勝率**: 44.9%
- **Sharpe**: 1.20
- **最大回撤**: -34.3%

**適用情境**:
- ✅ 穩健型投資者
- ✅ 追求較高勝率
- ✅ 不想頻繁調整停損
- ✅ 快速資金周轉

#### 方案三：追蹤止損 MA50（較保守）

**參數設定**:
```python
觸發條件: 2R 獲利
追蹤 MA: MA50
```

**績效表現**: 98.0% 報酬

**特點**:
- MA50 較 MA20 緩慢，給予更多空間
- 2R 觸發較晚，但更穩健
- 適合波動較大的股票

### 倉位管理建議

```python
# 基礎倉位（未實施分級）
單筆倉位 = 總資產 × 10%

# 未來分級倉位（建議）
A 級 HTF: 總資產 × 15%
B 級 HTF: 總資產 × 10%
C 級 HTF: 總資產 × 5%

# 風險控制
每筆交易風險 = 倉位 × (Buy_Price - Stop_Price) / Buy_Price
建議每筆風險 ≤ 總資產 × 2%（HTF 風險較高）

# 範例（A 級 HTF）
總資產 = 100 萬
單筆倉位 = 15 萬
Buy_Price = 100 元
Stop_Price = 85 元（15% 回檔）
風險 = 15 萬 × 15% = 22,500 元（2.25% 總資產）✓
```

### 實戰檢查清單

**進場前確認**:
- [ ] 旗桿漲幅 ≥ 60%（理想 > 80%）
- [ ] 旗形天數在 3-12 天之間
- [ ] 旗形回檔 ≤ 25%（理想 10-20%）
- [ ] 旗形成交量明顯萎縮
- [ ] RS Rating > 0（跑贏大盤）
- [ ] 評估 HTF 等級（A/B/C）
- [ ] 突破日成交量爆量（至少 2 倍）

**進場後管理**:
- [ ] 設定初始停損在 Stop_Price
- [ ] 監控是否達到 1.5R 獲利（觸發追蹤）
- [ ] 觸發後立即移至損益兩平
- [ ] 每日更新停損至 MA20
- [ ] 嚴格執行停損紀律

### HTF vs CUP 比較

| 特性 | HTF | CUP |
|------|-----|-----|
| **報酬率** | 210.1% | 314.3% |
| **勝率** | 31.7% | 56.9% |
| **Sharpe** | 0.79 | 2.24 |
| **最大回撤** | -39.7% | -12.2% |
| **風險特性** | 高風險高報酬 | 低風險高報酬 |
| **最佳策略** | 追蹤止損 | 固定目標 |
| **適合對象** | 積極型 | 穩健型 |
| **交易頻率** | 較高 | 中等 |
| **持有時間** | 彈性（追蹤） | 固定（20天） |

---

## 二、回測框架 (Backtest Framework)

### 複利邏輯（重要改進）

**傳統做法（錯誤）**:
```python
position_size = INITIAL_CAPITAL × 10%  # 永遠 10 萬
```

**複利做法（正確）**:
```python
# 每次開倉時重新計算
total_equity = current_cash + sum(active_positions_cost)
position_size = total_equity × 10%  # 隨總資產增長
```

**影響**:
- CUP: 184.9% → **314.3%** (+70%)
- HTF: 新增策略達到 **210.1%**
- 所有策略報酬提升 50-70%

### 資金管理參數

```python
初始資金: 100 萬
單筆倉位: 總資產 × 10%（複利計算）
最多持倉: 10 檔
分配原則: 先進先出 (FIFO)
```

### 進場邏輯

1. **訊號生成**: 每日檢查是否符合型態條件
2. **進場觸發**: 訊號後 30 天內，當日最高價 ≥ 買入價
3. **資金檢查**: 
   - 現金足夠（≥ 單筆倉位）
   - 持倉未滿（< 10 檔）
4. **部位規模**: 總資產 × 10%（複利）

### 出場邏輯

#### 固定目標策略
```python
優先順序:
1. 止損: 最低價 ≤ Stop_Price → 出場
2. 目標: 最高價 ≥ Target_Price → 出場
3. 時間: 持有天數達標 → 收盤價出場
```

#### 追蹤止損策略
```python
階段一（未觸發）:
- 當前停損 = Stop_Price
- 出場: 最低價 ≤ Stop_Price

階段二（已觸發 Trigger_R）:
- 停損移至損益兩平: Buy_Price
- 每日更新: max(當前停損, MA)
- 出場: 最低價 ≤ 當前停損
```

---

## 三、績效總結

### 最佳策略排名（含複利）

| 排名 | 策略 | 設定 | 報酬率 | 勝率 | Sharpe | 回撤 |
|------|------|------|--------|------|--------|------|
| 🥇 | CUP | R=3.0, T=20 | **314.3%** | 56.9% | 2.24 | -12.2% |
| 🥈 | HTF | Trig=1.5R, Trail=MA20 | **210.1%** | 31.7% | 0.79 | -39.7% |
| 🥉 | CUP | R=2.0, T=20 | **193.1%** | 57.3% | 2.16 | -14.5% |
| 4 | HTF | R=2.0, T=20 | **189.8%** | 44.9% | 1.20 | -34.3% |
| 5 | HTF | Trig=2.0R, Trail=MA20 | **154.2%** | 32.3% | 0.67 | -42.6% |

### 策略選擇建議

**穩健型投資者**:
- 首選: **CUP (R=3.0, T=20)**
- 理由: 最高 Sharpe、最低回撤、高勝率
- 預期: 年化報酬約 100-150%

**積極型投資者**:
- 首選: **HTF (Trig=1.5R, Trail=MA20)**
- 理由: 最高絕對報酬、能捕捉主升段
- 預期: 年化報酬約 80-120%，但回撤較大

**平衡型投資者**:
- 組合: **50% CUP + 50% HTF**
- 理由: 平衡報酬與風險
- 預期: 年化報酬約 100-130%，回撤適中

---

## 四、實務建議

### 交易紀律

1. **嚴格執行停損**: 絕不心存僥倖
2. **不要過度交易**: 等待高品質訊號
3. **記錄交易日誌**: 持續改進
4. **控制情緒**: 不因短期波動改變計畫

### 風險管理

1. **單筆風險**: ≤ 總資產 1-2%
2. **總風險**: 所有持倉總風險 ≤ 總資產 10%
3. **分散投資**: 不同產業、不同型態
4. **保留現金**: 至少 20% 現金應對機會

### 持續優化

1. **定期檢討**: 每月檢討交易績效
2. **參數調整**: 根據市場環境微調
3. **學習改進**: 分析失敗案例
4. **版本控制**: 使用 Git 記錄所有改動

---

**最終結論**: CUP 和 HTF 在台股市場表現優異，建議根據個人風險偏好選擇合適策略。複利效應對長期報酬影響巨大，務必在實際交易中應用。


**識別邏輯：**

*   **趨勢條件**：視窗內最高價相對於起始價上漲幅度 ≥ 40% (`min_up_ratio=0.4`)
*   **ZigZag 動態腿部識別**：
    *   使用 ZigZag 算法 (5% 敏感度) 識別擺動高點 (Swing Highs) 和擺動低點 (Swing Lows)
    *   從視窗最高點開始分析整理區域
    *   至少需要 2 個波谷 (Troughs) 才能形成有效的收縮型態
*   **收斂驗證**：
    *   **波幅遞減**：每一段的回檔深度 (Amplitude) 必須逐段遞減
        - 深度計算：`Depth_i = (Peak_i - Trough_i) / Peak_i`
        - 條件：`Depth_{i+1} < Depth_i`
    *   **低點墊高**：每一段的最低點需逐段墊高 (允許 2% 容差)
        - 條件：`Trough_{i+1} >= Trough_i * 0.98`
*   **成交量過濾 (Dry Up)**：
    *   計算最後 3 天的平均成交量
    *   要求：`Avg_Vol_Last3Days < Vol_MA50 * 0.6` (60% 門檻)
    *   此條件確保突破前成交量極度萎縮
*   **買點**：最後一個波峰 (Peak) 的價格
*   **停損**：最後一個波谷 (Trough) 的價格

**績效分析 (有限資金，100萬初始資金)：**

| 策略 | 報酬率 | 夏普比率 | 勝率 | 交易次數 | 最大回撤 |
|------|--------|----------|------|----------|----------|
| VCP (R=2.0, T=20) | -6.8% | -0.16 | 35.9% | 795 | -27.5% |
| VCP (R=3.0, T=20) | -10.6% | -0.21 | 32.5% | 452 | -36.1% |
| VCP (Trig=1.5R, Trail=MA20) | 23.0% | 0.31 | 27.1% | 387 | -31.3% |

**結論與建議：**

*   **表現不佳**：VCP 在有限資金場景下表現最差，固定出場策略呈現負報酬
*   **可能原因**：
    1. ZigZag 敏感度 (5%) 可能過於寬鬆，導致誤判
    2. 最低上漲幅度 (40%) 可能不足以過濾弱勢型態
    3. 成交量過濾條件可能過於嚴格，錯失有效訊號
*   **改進方向**：
    1. 調整 ZigZag 敏感度至 3-4%
    2. 提高最低上漲幅度至 50-60%
    3. 加入相對強度 (RS) 過濾，確保股票處於領先地位

---

### 2. High Tight Flag (HTF)

**識別邏輯：**

*   **旗桿 (Pole)**：視窗內最高價相對於起始價上漲 ≥ 80% (`min_up_ratio=0.8`)
*   **旗形 (Flag)**：
    *   整理天數在 3 ~ 12 天之間 (`min_flag_days=3`, `max_flag_days=12`)
    *   整理區回檔幅度不超過 25% (`max_pullback=0.25`)
    *   整理區平均成交量 < 上漲區平均成交量
*   **買點**：整理區 (Flag) 的最高價
*   **停損**：整理區 (Flag) 的最低價

**績效分析 (有限資金，100萬初始資金)：**

| 策略 | 報酬率 | 夏普比率 | 勝率 | 交易次數 | 最大回撤 |
|------|--------|----------|------|----------|----------|
| HTF (R=2.0, T=20) | **155.1%** | **1.52** | 48.3% | 543 | -15.1% |
| HTF (Trig=1.5R, Trail=MA20) | **288.3%** | 1.11 | 36.7% | 275 | -14.7% |
| HTF (R=3.0, T=20) | 131.8% | 1.19 | 44.4% | 473 | -17.0% |
| HTF (R=2.0, T=60) | 50.5% | 0.57 | 43.0% | 363 | -30.3% |

**結論與建議：**

*   **優異表現**：HTF 展現最高的絕對報酬率 (155-288%)
*   **風險調整後績效**：夏普比率 1.11-1.52，顯示良好的風險調整報酬
*   **特點**：
    1. 80% 漲幅門檻有效過濾弱勢型態，確保動能強勁
    2. 短期整理 (3-12 天) 捕捉快速突破機會
    3. 成交量萎縮確認整理有效性
    4. **追蹤止損策略表現優異**：Trig=1.5R, Trail=MA20 達到 288.3% 報酬
*   **改進方向**：
    1. 可考慮放寬天數限制至 15-20 天，捕捉更多強勢整理
    2. 加入移動平均線支撐確認 (如 MA10 或 MA20)

---

### 3. Cup with Handle (CUP)

**識別邏輯：**

*   **趨勢模板 (Trend Template - Minervini)**：
    *   **MA 排列**：`Price > MA50 > MA150 > MA200`
    *   **MA200 趨勢**：MA200 呈上升趨勢 (斜率 > 0)
    *   **52 週低點**：當前價格至少高於 52 週低點 25%
        - 條件：`Current_Price > Low_52Week * 1.25`
*   **杯身 (Cup)**：
    *   左側高點位於視窗前半段
    *   底部回檔深度在 12% ~ 33% 之間 (`min_depth=0.12`, `max_depth=0.33`)
    *   底部位置需大約在視窗中間 (U 型而非 V 型)
*   **把手 (Handle)**：
    *   位於右側高點之後
    *   長度至少為視窗的 20% 或 5 天
    *   **位置限制**：把手最低點必須在杯身深度的上半部
        - 條件：`Handle_Low > Cup_Low + 0.5 * (Cup_High - Cup_Low)`
    *   **漂移過濾**：把手區域必須呈現「價跌量縮」
        - 條件：`Handle_Vol_Mean < Window_Vol_Mean`
*   **買點**：把手區的最高價
*   **停損**：把手區的最低價

**績效分析 (有限資金，100萬初始資金)：**

| 策略 | 報酬率 | 夏普比率 | 勝率 | 交易次數 | 最大回撤 |
|------|--------|----------|------|----------|----------|
| CUP (R=3.0, T=20) | **152.5%** | **2.31** | 56.7% | 284 | -7.2% |
| CUP (R=2.0, T=20) | **133.1%** | **2.54** | 59.7% | 295 | **-6.5%** |
| CUP (R=2.0, T=60) | 75.7% | 1.55 | 55.8% | 163 | -11.3% |
| CUP (R=3.0, T=60) | 77.5% | 1.39 | 50.4% | 125 | -13.3% |
| CUP (Trig=1.5R, Trail=MA50) | 46.3% | 0.75 | 40.6% | 106 | -10.0% |

**結論與建議：**

*   **最佳風險調整報酬**：CUP 展現最高的夏普比率 (2.31-2.54)
*   **穩定勝率**：勝率維持在 50-60%，顯示型態可靠性高
*   **極低回撤**：最大回撤僅 6.5-7.2%，風險控制優異
*   **特點**：
    1. 趨勢模板有效過濾弱勢股票，確保處於上升趨勢
    2. 把手位置限制避免深度回檔的失敗型態
    3. 成交量漂移過濾確認整理健康
    4. **固定目標策略優於追蹤止損**：20天時間出場表現最佳
*   **最佳參數**：R=2.0-3.0, 時間出場=20天
*   **改進方向**：
    1. 可考慮加入相對強度 (RS) 排名，優先選擇領先股
    2. 細化把手長度要求，避免過短或過長的把手

---

## 二、回測框架 (Backtest Framework)

### 回測參數

1.  **策略 (Strategy)**: VCP, HTF, CUP
2.  **出場策略**：
    *   **固定目標 (Fixed Target)**: 2R, 3R
    *   **時間出場 (Time Exit)**: 20 天, 60 天
    *   **追蹤止損 (Trailing Stop)**: 
        - **觸發條件**：達到 1.5R 或 2R 獲利
        - **初始動作**：止損立即移至損益兩平 (Breakeven = 買入價)
        - **MA 追蹤**：跟隨 MA20 或 MA50，止損永不下移
        - **出場條件**：當日最低價 ≤ 當前止損
3.  **資金管理 (Capital Management)**：
    *   **Scenario 1 (有限資金)**: 
        - 初始資金：100 萬
        - 單筆上限：10% (10 萬)
        - 最多持倉：10 檔
        - 分配原則：先進先出 (FIFO)
    *   **Scenario 2 (無限資金)**: 
        - 所有符合訊號皆進場
        - 用於理論績效比較

### 統計指標

*   **勝率 (Win Rate)**: 獲利交易佔總交易的比例
*   **總獲利 (Total Profit)**: 所有交易的累積損益
*   **報酬率 (Return %)**: `(Final_Equity - Initial_Capital) / Initial_Capital * 100`
*   **最大回撤 (Max Drawdown)**: 淨值曲線的最大跌幅百分比
*   **夏普比率 (Sharpe Ratio)**: 年化風險調整報酬
    - 計算公式：`(Avg_Daily_Return - Risk_Free_Rate) / Std_Daily_Return * sqrt(252)`
*   **最大連續獲利/虧損 (Max Consecutive Win/Loss)**: 連續獲利/虧損交易的最大次數
*   **交易次數 (Count)**: 總交易筆數

### 進場邏輯

1.  **訊號生成**：每日檢查是否符合型態條件
2.  **進場觸發**：訊號生成後 30 天內，當日最高價 ≥ 買入價即觸發進場
3.  **資金檢查** (有限資金場景)：
    *   檢查當前現金是否足夠 (≥ 單筆上限)
    *   檢查持倉數量是否未達上限 (< 10 檔)
4.  **部位規模**：固定使用總資產的 10%

### 出場邏輯

#### 固定目標策略

1.  **止損出場**：當日最低價 ≤ 停損價
2.  **目標出場**：當日最高價 ≥ 目標價 (買入價 + R * 風險)
3.  **時間出場**：持有天數達到設定值，以收盤價出場
4.  **優先順序**：止損 > 目標 > 時間

#### 追蹤止損策略

1.  **初始止損**：使用型態識別的停損價
2.  **觸發條件**：當日最高價 ≥ 觸發價 (買入價 + Trigger_R * 風險)
3.  **止損上移至損益兩平**：觸發後立即將止損移至買入價
4.  **MA 動態追蹤**：每日更新止損為 `max(當前止損, MA值)`
5.  **出場條件**：當日最低價 ≤ 當前止損

### 績效總結

#### 有限資金場景 (Top 10)

| 排名 | 策略 | 設定 | 報酬率 | 夏普比率 | 勝率 | 交易次數 | 最大回撤 |
|------|------|------|--------|----------|------|----------|----------|
| 1 | HTF | Trig=1.5R, Trail=MA20 | **288.3%** | 1.11 | 36.7% | 275 | -14.7% |
| 2 | HTF | R=2.0, T=20 | **155.1%** | **1.52** | 48.3% | 543 | -15.1% |
| 3 | CUP | R=3.0, T=20 | **152.5%** | **2.31** | 56.7% | 284 | -7.2% |
| 4 | HTF | Trig=2.0R, Trail=MA20 | 138.7% | 0.70 | 28.8% | 236 | -18.2% |
| 5 | CUP | R=2.0, T=20 | 133.1% | **2.54** | 59.7% | 295 | **-6.5%** |
| 6 | HTF | R=3.0, T=20 | 131.8% | 1.19 | 44.4% | 473 | -17.0% |
| 7 | HTF | Trig=2.0R, Trail=MA50 | 124.3% | 0.60 | 24.8% | 214 | -17.1% |
| 8 | HTF | Trig=1.5R, Trail=MA50 | 101.0% | 0.55 | 24.1% | 253 | -28.5% |
| 9 | CUP | R=3.0, T=60 | 77.5% | 1.39 | 50.4% | 125 | -13.3% |
| 10 | CUP | R=2.0, T=60 | 75.7% | 1.55 | 55.8% | 163 | -11.3% |

#### 關鍵發現

1.  **HTF 追蹤止損表現優異**：
    - HTF + 追蹤止損 (Trig=1.5R, Trail=MA20) 達到 **288.3% 報酬**
    - 適合動能強勁的股票，讓獲利部位持續奔跑
    - MA20 追蹤比 MA50 更靈敏，適合快速移動的股票
    
2.  **CUP 最穩健**：
    - 最高夏普比率 (2.31-2.54)，最低回撤 (-6.5% to -7.2%)
    - 固定目標策略 (R=2.0-3.0, T=20) 表現最佳
    - 勝率高達 56-60%，顯示型態可靠性極高
    
3.  **HTF 最激進**：
    - 固定目標策略 (R=2.0, T=20) 有 155.1% 報酬，夏普 1.52
    - 追蹤止損策略可達 288.3% 報酬
    - 適合追求高報酬的積極型投資者
    
4.  **VCP 需改進**：
    - 表現不佳，多數策略呈現負報酬或低報酬
    - 需要重新調整參數或過濾條件
    
5.  **最佳時間出場**：
    - **20 天**為最佳平衡點（CUP 和 HTF 皆表現優異）
    - 60 天時間出場報酬率較低，可能錯過最佳出場時機

---

## 三、實現細節

### 技術架構

*   **數據處理**：Polars (高效能 DataFrame)
*   **向量化運算**：NumPy (快速數值計算)
*   **並行處理**：ProcessPoolExecutor (多核心加速)
*   **視窗大小**：126 天 (約 6 個月)

### 程式檔案

*   **[pattern_analysis.py](file:///Users/sony/ml_stock/stock/pattern_analysis.py)**: 型態識別與訊號生成
*   **[backtest_patterns.py](file:///Users/sony/ml_stock/stock/backtest_patterns.py)**: 回測引擎與績效計算

---

## 四、未來改進方向

### VCP 型態優化

1.  調整 ZigZag 敏感度 (3-4%)
2.  提高最低上漲幅度門檻 (50-60%)
3.  加入相對強度 (RS) 過濾
4.  細化成交量過濾條件

### 資金管理優化

1.  **Kelly Criterion**: 根據勝率和賠率動態調整部位大小
2.  **波動率調整**: 根據 ATR 或歷史波動率調整部位
3.  **風險平價**: 確保每筆交易的風險相等

### 交易成本建模

1.  加入手續費 (0.1425% * 折扣)
2.  加入證交稅 (0.3%)
3.  加入滑價模型 (Slippage)

### 穩健性測試

1.  **Walk-Forward Analysis**: 滾動式樣本內外測試
2.  **Monte Carlo Simulation**: 隨機排列測試
3.  **參數敏感度分析**: 測試參數變化對績效的影響
